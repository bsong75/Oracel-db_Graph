services:
  oracle-db:
    build: ./oracle_db
    container_name: oracle-graph-db
    env_file:
      - .env
    environment:
      - ORACLE_PASSWORD=${ORACLE_PASSWORD:-OraclePassword123}
      - APP_USER=${ORACLE_USER:-graphuser}
      - APP_USER_PASSWORD=${GRAPH_PASSWORD:-GraphPassword123}
    ports:
      - "1521:1521"
      - "5500:5500"
      - "7007:7007"
    volumes:
      - oracle-data:/opt/oracle/oradata
      - ./oracle_db/init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "echo 'SELECT 1 FROM DUAL;' | sqlplus -s sys/${ORACLE_PASSWORD:-OraclePassword123}@//localhost:1521/FREE as sysdba || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 180s
    networks:
      - oracle-network

  graph-server:
    image: container-registry.oracle.com/database/graph-quickstart:latest
    container_name: oracle-graph-server
    env_file:
      - .env
    environment:
      - BASE_URL=http://oracle-db:1521
      - ENABLE_TLS=false
      - PGX_ENABLE_SECURITY=false
      - JAVA_OPTS=-Xms2g -Xmx4g
    depends_on:
      oracle-db:
        condition: service_healthy
    network_mode: "service:oracle-db"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:7007/ui/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  python-app:
    build: ./main_app
    container_name: oracle-graph-app
    env_file:
      - .env
    environment:
      - ORACLE_HOST=${ORACLE_HOST:-oracle-db}
      - ORACLE_PORT=${ORACLE_PORT:-1521}
      - ORACLE_SERVICE=${ORACLE_SERVICE:-FREE}
      - ORACLE_USER=${ORACLE_USER:-graphuser}
      - ORACLE_PASSWORD=${GRAPH_PASSWORD:-GraphPassword123}
      - PGX_BASE_URL=${PGX_BASE_URL:-http://graph-server:7007}
      - CSV_FILE_PATH=${CSV_FILE_PATH:-/app/data/pest_data.csv}
    volumes:
      - ./main_app:/app
      - ./data:/app/data
    depends_on:
      oracle-db:
        condition: service_healthy
      graph-server:
        condition: service_healthy
    networks:
      - oracle-network
    command: ["python", "pest_analysis_classes.py"]

volumes:
  oracle-data:

networks:
  oracle-network:
    driver: bridge
